{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Lesson" %}{% endblock %}

{% block style %}
<style>
:root{
  --primary:#007bff;
  --bg-dark:#1e1e1e;
  --radius:12px;
  --shadow:0 8px 30px rgba(0,0,0,0.15);
  --font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
}

.lesson-container{
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:28px 16px;
  min-height:100vh;
  font-family:var(--font);
  background:#f7f8fb;
}

.video-wrapper{
  width:100%;
  max-width:960px;
  position:relative;
  border-radius:var(--radius);
  overflow:hidden;
  box-shadow:var(--shadow);
  background:#000;
}

.lesson-video{
  width:100%;
  display:block;
  background:black;
}

/* controls */
.controls{
  position:absolute;
  left:0; right:0; bottom:0;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px;
  background:linear-gradient(180deg,rgba(0,0,0,0),rgba(0,0,0,0.7));
  box-sizing:border-box;
}

.left-controls, .center-controls, .right-controls{
  display:flex;
  align-items:center;
  gap:8px;
}

.progress-container{
  flex:1;
  height:8px;
  background:rgba(255,255,255,0.12);
  border-radius:6px;
  cursor:pointer;
  position:relative;
}
.progress-buffer, .progress-played{
  position:absolute; left:0; top:0; height:100%; border-radius:6px;
}
.progress-buffer{ background:rgba(255,255,255,0.25); width:0%; }
.progress-played{ background:var(--primary); width:0%; }

.btn{
  background:transparent;
  border:none;
  color:#fff;
  cursor:pointer;
  font-size:16px;
  padding:6px;
  border-radius:6px;
}
.time{
  color:#fff;
  font-size:13px;
  min-width:95px;
  text-align:center;
}

/* actions under video */
.lesson-actions{
  margin-top:20px;
  display:flex;
  gap:12px;
  width:100%;
  max-width:420px;
  justify-content:center;
}
.action-btn{
  flex:1;
  padding:10px 12px;
  border-radius:12px;
  font-weight:600;
  cursor:pointer;
  border:none;
}
.btn-back{ background:var(--primary); color:#fff; }
.btn-done{ background:#28a745; color:#fff; }

@media (prefers-color-scheme: dark){
  .lesson-container{ background:var(--bg-dark); color:#fff; }
}
</style>
{% endblock %}

{% block content %}
<div class="lesson-container">
  <div class="video-wrapper">
    <video id="lesson-video" class="lesson-video" preload="metadata">
      <source src="{{ lesson.video_file.url }}" type="video/mp4">
      {% trans "Your browser does not support videos" %}
    </video>

    <div class="controls">
      <div class="left-controls">
        <button id="play-pause" class="btn">‚ñ∂Ô∏è</button>
        <div class="time" id="time-display">0:00 / 0:00</div>
      </div>

      <div class="center-controls">
        <div class="progress-container" id="progress-container">
          <div class="progress-buffer" id="progress-buffer"></div>
          <div class="progress-played" id="progress-played"></div>
        </div>
      </div>

      <div class="right-controls">
        <button id="mute" class="btn">üîä</button>
        <input id="volume" type="range" min="0" max="1" step="0.01" value="1">
        <select id="speed">
          <option value="0.5">0.5x</option>
          <option value="0.75">0.75x</option>
          <option value="1" selected>1x</option>
          <option value="1.25">1.25x</option>
          <option value="1.5">1.5x</option>
          <option value="2">2x</option>
        </select>
        <button id="fullscreen" class="btn">‚õ∂</button>
      </div>
    </div>
  </div>

  <div class="lesson-actions">
    <button onclick="goBack()" class="action-btn btn-back">‚¨ÖÔ∏è {% trans "Back" %}</button>
    <button onclick="markDone()" class="action-btn btn-done">‚úÖ {% trans "Done" %}</button>
  </div>
</div>
{% endblock %}

{% block script %}
<script>
const video = document.getElementById('lesson-video');
const playBtn = document.getElementById('play-pause');
const fullscreenBtn = document.getElementById('fullscreen');
const speedSelect = document.getElementById('speed');
const volumeSlider = document.getElementById('volume');
const muteBtn = document.getElementById('mute');
const progressContainer = document.getElementById('progress-container');
const progressPlayed = document.getElementById('progress-played');
const progressBuffer = document.getElementById('progress-buffer');
const timeDisplay = document.getElementById('time-display');

let isSeeking = false;
let wasPlaying = false;

// ------------------ LOG FUNCTION ------------------
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + "=")) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function sendLog(action) {
  fetch("{% url 'home:log_action' lesson.id %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": getCookie("csrftoken"),
      "Content-Type": "application/x-www-form-urlencoded",
    },
    body: "action=" + action,
  }).catch(err => console.error("Log error:", err));
}
// --------------------------------------------------

// helpers
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
function fmtTime(s){ if(isNaN(s)) return "0:00"; return `${Math.floor(s/60)}:${String(Math.floor(s%60)).padStart(2,'0')}`; }
function safePlay(){ const p = video.play(); if(p?.then) p.catch(()=>{}); }
function seek(pos){ video.currentTime = clamp(pos*video.duration,0,video.duration); }

// update UI
function updateTime(){ timeDisplay.textContent = `${fmtTime(video.currentTime)} / ${fmtTime(video.duration)}`; }
function updateProgress(){ progressPlayed.style.width = ((video.currentTime/video.duration)*100||0)+'%'; }
function updateBuffer(){ if(video.buffered.length>0) progressBuffer.style.width = ((video.buffered.end(video.buffered.length-1)/video.duration)*100||0)+'%'; }

// play/pause
playBtn.addEventListener('click', ()=>{ video.paused ? safePlay() : video.pause(); });
video.addEventListener('play', ()=> { playBtn.textContent='‚è∏'; sendLog("play"); });
video.addEventListener('pause', ()=> { playBtn.textContent='‚ñ∂Ô∏è'; sendLog("pause"); });

// volume/mute
volumeSlider.addEventListener('input', ()=>{ video.volume=volumeSlider.value; video.muted=(video.volume===0); muteBtn.textContent=video.muted?'üîá':'üîä'; });
muteBtn.addEventListener('click', ()=>{ video.muted=!video.muted; muteBtn.textContent=video.muted?'üîá':'üîä'; });

// speed
speedSelect.addEventListener('change', ()=>{ video.playbackRate = parseFloat(speedSelect.value); });

// fullscreen
fullscreenBtn.addEventListener('click', ()=>{ const el=video.parentElement; document.fullscreenElement?document.exitFullscreen():el.requestFullscreen(); });

// progress
function pointerSeek(e){
  const rect = progressContainer.getBoundingClientRect();
  seek((e.clientX-rect.left)/rect.width);
}

progressContainer.addEventListener('pointerdown', e=>{ isSeeking=true; wasPlaying=!video.paused; video.pause(); pointerSeek(e); });
progressContainer.addEventListener('pointermove', e=>{ if(isSeeking) pointerSeek(e); });
progressContainer.addEventListener('pointerup', e=>{ if(isSeeking){ isSeeking=false; if(wasPlaying) safePlay(); } });
progressContainer.addEventListener('click', pointerSeek);

// update loop
video.addEventListener('timeupdate', ()=>{ if(!isSeeking) updateProgress(); updateTime(); });
video.addEventListener('progress', updateBuffer);
video.addEventListener('loadedmetadata', ()=>{ updateProgress(); updateBuffer(); updateTime(); });

// back & done
function goBack(){
  sendLog("back");
  window.history.back();
}
function markDone(){
  sendLog("done");
  if(confirm("{% trans '‚úÖ B·∫°n ƒë√£ ho√†n th√†nh b√†i h·ªçc! B·∫•m OK ƒë·ªÉ quay l·∫°i kho√° h·ªçc.' %}")){
    window.location.href="{% url 'home:course_detail' lesson.course.code %}";
  }
}

// log khi tho√°t trang
window.addEventListener("beforeunload", ()=> sendLog("back"));
</script>
{% endblock %}
